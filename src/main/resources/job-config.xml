<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xmlns:task="http://www.springframework.org/schema/task"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/batch
        http://www.springframework.org/schema/batch/spring-batch.xsd
        http://www.springframework.org/schema/task
        http://www.springframework.org/schema/task/spring-task.xsd">

    <!-- Define the transaction manager bean -->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!-- Define the reader, processor, and writer beans with their dependencies -->
    <bean id="reader" class="com.itemis.feedback.FeedbackItemReader"/>
    <bean id="processor" class="com.itemis.feedback.FeedbackProcessor"/>
    <bean id="writer" class="com.itemis.feedback.FeedbackItemWriter"/>
    <bean id="jobCompletionNotificationListener" class="com.itemis.feedback.JobCompletionNotificationListener"/>
    <bean id="badFeedbackStepExecutionListener" class="com.itemis.feedback.BadFeedbackStepExecutionListener"/>
    <bean id="filesWrapper" class="com.itemis.feedback.FilesWrapper"/>

    <!-- Define the tasklets -->
    <bean id="moveFileTasklet" class="org.springframework.batch.core.step.tasklet.MethodInvokingTaskletAdapter">
        <property name="targetObject" ref="filesWrapper"/>
        <property name="targetMethod" value="move"/>
        <property name="arguments">
            <list>
                <value type="java.lang.String">resources/feedback.csv</value>
                <value type="java.lang.String">resources/processed/feedback.csv</value>
            </list>
        </property>
    </bean>

    <bean id="sendEMailToSupportTasklet" class="com.itemis.feedback.SendEMailTasklet">
        <property name="badFeedbackFile">
            <bean class="java.io.File">
                <constructor-arg value="resources/processed/feedback.csv"/>
            </bean>
        </property>
        <property name="eMailAddress" value="support@itemis.com"/>
    </bean>

    <bean id="sendEMailToDevelopmentTasklet" class="com.itemis.feedback.SendEMailTasklet">
        <property name="badFeedbackFile">
            <bean class="java.io.File">
                <constructor-arg value="resources/processed/feedback.csv"/>
            </bean>
        </property>
        <property name="eMailAddress" value="product.development@itemis.com"/>
    </bean>

    <!-- Define the steps -->
    <!--task:executor id="taskExecutor" class="org.springframework.core.task.SimpleAsyncTaskExecutor"/-->
    <task:executor id="taskExecutor"/>

    <!-- Define the job and its flow -->
    <batch:job id="feedbackJob" job-repository="jobRepository">
        <batch:listeners>
            <batch:listener ref="jobCompletionNotificationListener"/>
        </batch:listeners>

        <batch:step id="processFeedbackStep">
            <batch:tasklet transaction-manager="transactionManager">
                <batch:chunk reader="reader" processor="processor" writer="writer" commit-interval="3"/>
                <batch:listeners>
                    <batch:listener ref="badFeedbackStepExecutionListener"/>
                </batch:listeners>
            </batch:tasklet>
            <batch:next on="COMPLETED_WITH_BAD_FEEDBACK" to="splitFlow"/>
            <batch:next on="COMPLETED" to="moveFileStep"/>
        </batch:step>

        <batch:step id="moveFileStep">
            <batch:tasklet ref="moveFileTasklet" transaction-manager="transactionManager"/>
        </batch:step>

        <batch:split id="splitFlow" task-executor="taskExecutor" next="moveFileStep">
            <batch:flow>
                <batch:step id="sendEMailToSupportStep" >
                    <batch:tasklet ref="sendEMailToSupportTasklet" transaction-manager="transactionManager"/>
                </batch:step>
            </batch:flow>
            <batch:flow>
                <batch:step id="sendEMailToDevelopmentStep" >
                    <batch:tasklet ref="sendEMailToDevelopmentTasklet" transaction-manager="transactionManager"/>
                </batch:step>
            </batch:flow>
        </batch:split>
    </batch:job>

</beans>
